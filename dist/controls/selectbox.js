"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,l){void 0===l&&(l=r),Object.defineProperty(e,l,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,l){void 0===l&&(l=r),e[l]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SelectBoxStyle=exports.selectBoxClassName=void 0;const string_utils_1=__importDefault(require("@bizhermit/basic-utils/dist/string-utils")),react_1=__importStar(require("react")),icon_1=__importDefault(require("../graphics/icon")),controller_1=__importStar(require("../hooks/controller")),popup_1=__importDefault(require("../hooks/popup")),prop_1=__importDefault(require("../hooks/prop")),value_1=__importDefault(require("../hooks/value")),input_1=__importStar(require("../layouts/input")),style_1=__importDefault(require("../layouts/style")),classname_utils_1=require("../utils/classname-utils"),dom_utils_1=require("../utils/dom-utils"),listview_1=__importStar(require("./listview"));exports.selectBoxClassName="bh-slb";const SelectBox=e=>{const t=(0,react_1.useRef)(),r=(0,react_1.useRef)(),l=(0,prop_1.default)(e.labelDataName??"label"),a=(0,prop_1.default)(e.valueDataName??"value"),u=(0,popup_1.default)(listview_1.default,{className:`${exports.selectBoxClassName}-list`}),[n,s]=(0,react_1.useState)(!0),i=(0,react_1.useRef)((0,listview_1.listViewDefaultRowHeight)()),o=(0,react_1.useRef)([]),c=(0,react_1.useRef)([]),[d,_]=(0,react_1.useState)(null),f=(0,react_1.useMemo)((()=>[{name:l.current,fill:!0,width:10,cellTextAlign:e.textAlign??"left"}]),[]),p=(0,controller_1.default)(),m=(0,react_1.useRef)(""),h=(0,react_1.useRef)(""),g=(0,react_1.useCallback)((e=>{if(string_utils_1.default.isEmpty(e))return h.current="",void _(null);h.current!==e&&_((()=>t=>-1!==String(t[l.current||""]).indexOf(e)))}),[]),x=e=>{if(n)return;const t=[];if(Array.isArray(e)){for(const r of e)for(const e of o.current)if(e[l.current]===r){t.push(String(e[l.current]));break}}else for(const r of o.current)if(r[a.current]===e){t.push(String(r[l.current]));break}return m.current=t.join(","),r.current&&(r.current.value=m.current),m.current},{getValue:b,setValue:y}=(0,value_1.default)(e,{binded:e=>x(e),changed:e=>x(e),convertChangedArgData:e=>({value:e,data:o.current.find((t=>t[a.current]===e))}),defaultValue:c.current[0]?.[a.current]}),v=(0,react_1.useCallback)((e=>{u.hide(e)}),[]),w=l=>{if(!0===e.disabled||n)return;if(!0!==l&&u.isShowed())return;const s=t.current.getBoundingClientRect(),_=document.body.clientHeight,m=t=>Math.min(e.listMaxHeight??400,i.current*t+2,Math.max(_-s.bottom,s.top)-5);u.show(t.current,{componentProps:{controller:p,style:{height:"100%",width:"100%"},columns:f,value:c.current,options:{clickedRow:e=>{y(e.data[a.current]),r.current.focus(),v(!0)},filter:d,filtered:e=>{u.getElement().style.height=m(e.length)+"px"},header:!1,rowNumber:!1,rowHeignt:i.current,selectMode:"row",enterIsClick:!0}},createMountElementCallback:e=>{(0,dom_utils_1.setStyleProps)(e,{width:`${t.current.offsetWidth}px`,height:`${m(o.current.length)}px`,minHeight:`${i.current}px`})},showedCallback:()=>{setTimeout((()=>{const e=b();for(let t=0,r=c.current.length;t<r;t++)if(c.current[t][a.current]===e){p?.select(t);break}}),0)},hideCallback:()=>{if(document.activeElement===r.current)return!1}})},C=()=>{g(""),w(),e.focus?.(b())},N=(0,dom_utils_1.horizontalResizeMousedown)(e);return(0,react_1.useEffect)((()=>{u.isShowed()&&w(!0)}),[d]),(0,controller_1.initController)(e.controller,(e=>{e.focus=()=>(r.current?.focus(),w(),e),e.blur=()=>(r.current?.blur(),e),e.getValue=()=>b(),e.setValue=t=>(y(t),e)})),(0,react_1.useEffect)((()=>{s(!0);const t=t=>{if(o.current=t??[],!0===e.appendEmptyItem&&null==o.current.find((e=>null==e[a.current]))){const e={};e[a.current]=null,e[l.current]="",o.current.unshift(e)}c.current=o.current.concat(),s(!1),e.defaultItemIsFirstItem&&null==b()&&y(o.current[0]?.[a.current]),x(b())};null==e.source?t([]):Array.isArray(e.source)?t(e.source):(async()=>{try{t(await e.source())}catch{console.log("failed: load radiobutton source"),t([])}})()}),[e.source]),(0,react_1.useEffect)((()=>{x(b())}),[e.disabled,n]),react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement("div",{ref:t,style:e.style,className:(0,classname_utils_1.className)(input_1.InputClassNames.wrap,exports.selectBoxClassName,e.className),"data-disabled":!0===e.disabled||n,"data-required":e.required},!0===e.disabled||n?react_1.default.createElement("span",{className:input_1.InputClassNames.lbl,"data-align":e.textAlign??"left",title:e.title},m.current):react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement("input",{ref:r,className:input_1.InputClassNames.ipt,type:"text",readOnly:!1===e.inputText,onChange:e=>g(e.currentTarget.value),onFocus:C,onClick:()=>{C()},onKeyDown:t=>{if("Tab"!==t.key)if("ArrowDown"!==t.key&&"ArrowUp"!==t.key)if("Backspace"!==t.key){if("Escape"!==t.key)return"F2"===t.key?(g(""),void w()):void 0;v()}else w();else u.isShowed()?(p.focus(),t.preventDefault()):w();else setTimeout((()=>{v(!0),e.blur?.(b())}),0)},"data-align":e.textAlign??"left",title:e.title}),react_1.default.createElement("div",{className:input_1.InputClassNames.btn,onClick:()=>{!1===e.inputText?C():r.current.focus()},tabIndex:-1},react_1.default.createElement(icon_1.default,{image:"pulldown"}))),!1===e.resize?react_1.default.createElement(react_1.default.Fragment,null):react_1.default.createElement("div",{className:input_1.InputClassNames.resize_x,onMouseDown:N})),input_1.default,exports.SelectBoxStyle)};exports.default=SelectBox,exports.SelectBoxStyle=react_1.default.createElement(style_1.default,{id:exports.selectBoxClassName,notDepsColor:!0,css:({design:e})=>`\n.${exports.selectBoxClassName}-list .${listview_1.listViewClassName}-cell {\n  cursor: pointer;\n}\n${"material"===e?`\n.${exports.selectBoxClassName} > .${input_1.InputClassNames.ipt} {\n  border-top-right-radius: 0px;\n  border-bottom-right-radius: 0px;\n}\n`:""}\n${"neumorphism"===e?`\n.${exports.selectBoxClassName} > .${input_1.InputClassNames.ipt} {\n  border-top-right-radius: 0px;\n  border-bottom-right-radius: 0px;\n}\n`:""}\n`});