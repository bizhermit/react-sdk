"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,s){void 0===s&&(s=a),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,s){void 0===s&&(s=a),e[s]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.FileListViewStyle=exports.fileListViewClassName=void 0;const react_1=__importStar(require("react")),icon_1=__importDefault(require("../graphics/icon")),controller_1=require("../hooks/controller"),input_1=__importStar(require("../layouts/input")),style_1=__importStar(require("../layouts/style")),classname_utils_1=require("../utils/classname-utils");exports.fileListViewClassName="bh-flv";const dragingClassName="bh-draging",FileListView=e=>{const t=(0,react_1.useRef)(),a=(0,react_1.useRef)(),s=(0,react_1.useRef)(e.name??"files"),l=(0,react_1.useRef)({}),[n,i]=(0,react_1.useState)(0),[r,o]=(0,react_1.useState)(e.accordionOpenWhenAtFirst??!0),c=(0,react_1.useRef)(e.maxSize??0),d=(0,react_1.useMemo)((()=>e.accept?e.accept.join(","):"."),[e.accept]),m=(0,react_1.useRef)({count:0,size:0}),u=(0,react_1.useCallback)((()=>{const e=l.current[s.current];return Array.isArray(e)?e:[]}),[]),f=t=>{const s=u(),l=!0===e.maxIsAdd;let n=0,r=0;const o=s.concat();s.forEach((e=>{e.delete||l&&!e.add||(n+=e.size,r++)}));for(let a=0,l=t.length;a<l;a++){const l=t.item(a);if(e.accept){const t=l.name.substring(l.name.lastIndexOf("."),l.name.length);let a=!1;for(const s of e.accept)if(a=s===t,a)break;if(!a)continue}if(null!=e.maxCount&&r+1>e.maxCount){e.overMaxCountCallback?.();break}if(c.current&&n+l.size>e.maxSize){e.overMaxSizeCallback?.();break}s.push({file:l,name:l.name,size:l.size,path:l.path??"",download:!1,add:!0,delete:!1}),n+=l.size,r++}a.current&&(a.current.value=""),e.changed?.(s.concat(),o.concat()),i((e=>e+1))},_=(0,react_1.useCallback)((t=>{e.downloadItem?.(t)}),[e.downloadItem]),p=t=>{const a=u(),s=a.concat();let l=!1;for(let e=0,s=a.length;e<s;e++){const s=a[e];if(s===t){if(s.add){a.splice(e,1),l=!0;break}s.delete=!s.delete;break}}l&&e.changed?.(a.concat(),s.concat()),i((e=>e+1))},{itmeNodes:C,fileSize:w,fileSizeOnlyAdd:$}=(0,react_1.useMemo)((()=>{const t=[],a=u();let s=0,l=0,n=0;const i=a=>{t.push(react_1.default.createElement(FileItem,{key:s++,item:a,downloadUI:e.downloadUI??"button",toggleDelete:p,download:_,disabled:!0===e.disabled})),a.delete||(l+=a.size??0,a.add&&(n+=a.size??0))};if(!1===e.addToTop)for(const e of a)i(e);else for(let e=a.length-1;e>=0;e--)i(a[e]);return m.current.count=t.length,m.current.size=l,{itmeNodes:t,fileSize:l,fileSizeOnlyAdd:n}}),[n,e.disabled,e.addToTop]);(0,react_1.useEffect)((()=>{l.current=e.bind??{},l.current[s.current]=l.current[s.current]??[],a.current&&(a.current.value="",i((e=>e+1)))}),[e.bind]),(0,controller_1.initController)(e.controller,(e=>{e.focus=()=>(t.current?.focus(),e),e.blur=()=>(t.current?.blur(),e),e.getCount=()=>m.current.count,e.getSize=()=>m.current.size}));const g=null!=e.accordionItemCount&&C.length>e.accordionItemCount;return react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement("div",{ref:t,className:(0,classname_utils_1.className)(`${exports.fileListViewClassName}`,e.className),style:e.style,onDragOver:e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy",e.currentTarget.classList.contains("bh-draging")||e.currentTarget.classList.add("bh-draging")},onDragLeave:e=>{e.currentTarget.classList.remove("bh-draging")},onDrop:e=>{e.currentTarget.classList.remove("bh-draging"),f(e.dataTransfer.files)},"data-disabled":!0===e.disabled},!0===e.disabled?react_1.default.createElement(react_1.default.Fragment,null):react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement("input",{ref:a,className:`${exports.fileListViewClassName}-input`,type:"file",accept:d,tabIndex:-1,onChange:e=>{f(e.currentTarget.files),e.currentTarget.value=""},multiple:!0}),react_1.default.createElement("div",{className:`${exports.fileListViewClassName}-dragdrop`,onClick:()=>{a.current.click()}},e.dragDropText??"please click or drag & drop")),react_1.default.createElement("div",{className:`${exports.fileListViewClassName}-wrap`,"data-acc":g},react_1.default.createElement("div",{className:`${exports.fileListViewClassName}-items ${style_1.scrollbarClassName}`,style:{maxHeight:null==e.accordionItemCount||r?null:`calc(${style_1.CssVar.file_lv.itemHeight} * ${e.accordionItemCount})`},"data-count":e.accordionItemCount??"","data-opened":r},C)),g?react_1.default.createElement("div",{className:`${input_1.InputClassNames.btn_o} ${exports.fileListViewClassName}-accordion`,onClick:()=>o(!r),"data-opened":r},react_1.default.createElement("div",{className:`${exports.fileListViewClassName}-icon`},react_1.default.createElement(icon_1.default,{image:r?"pullup":"pulldown"}))):react_1.default.createElement(react_1.default.Fragment,null),"none"===e.displaySizeSummary?react_1.default.createElement(react_1.default.Fragment,null):react_1.default.createElement("div",{className:`${exports.fileListViewClassName}-footer`},react_1.default.createElement("div",{className:`${exports.fileListViewClassName}-sum-caption`},e.summaryCaptionText??"Total: "),react_1.default.createElement("div",{className:`${exports.fileListViewClassName}-sum`},fileSizeStr("onlyAdd"===e.displaySizeSummary?$:w)))),input_1.default,exports.FileListViewStyle)};exports.default=FileListView;const fileListViewItemClassName=`${exports.fileListViewClassName}-item`,FileItem=({item:e,toggleDelete:t,download:a,downloadUI:s,disabled:l})=>react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement("div",{className:`${fileListViewItemClassName}`,"data-delete":e.delete??!1,title:e.name},"button"===s?react_1.default.createElement("div",{className:`${fileListViewItemClassName}-download-wrap`},e.download?react_1.default.createElement("div",{className:input_1.InputClassNames.btn_o,onClick:()=>a(e)},react_1.default.createElement(icon_1.default,{image:"download"})):react_1.default.createElement(react_1.default.Fragment,null)):react_1.default.createElement(react_1.default.Fragment,null),react_1.default.createElement("div",{className:`${fileListViewItemClassName}-name`},react_1.default.createElement("div",{className:`${fileListViewItemClassName}-lbl ${fileListViewItemClassName}-file_name${"anchor"===s&&e.download?" bh-anchor":""}`,onClick:"anchor"===s&&e.download?()=>a(e):null},e.name),null==e.path?react_1.default.createElement(react_1.default.Fragment,null):react_1.default.createElement("div",{className:`${fileListViewItemClassName}-lbl ${fileListViewItemClassName}-file_path`},e.path)),react_1.default.createElement("div",{className:`${fileListViewItemClassName}-lbl ${fileListViewItemClassName}-size`},fileSizeStr(e.size)),l?react_1.default.createElement(react_1.default.Fragment,null):react_1.default.createElement("div",{className:input_1.InputClassNames.btn_o,onClick:()=>t(e)},react_1.default.createElement(icon_1.default,{image:e.delete?"reload":"delete"})))),fileSizeStr=e=>null==e?"":e<1024?`${e} B`:e<1048576?Math.ceil(10*e/1024)/10+" KB":e<1073741824?Math.ceil(100*e/1048576)/100+" MB":Math.ceil(100*e/1073741824)/100+" GB";exports.FileListViewStyle=react_1.default.createElement(style_1.default,{id:exports.fileListViewClassName,notDepsColor:!0,css:({design:e})=>`\n.${exports.fileListViewClassName} {\n  ${style_1.CssPV.flex_c}\n  flex: none;\n}\n.${exports.fileListViewClassName}-dragdrop {\n  ${style_1.CssPV.flex_r_c}\n  cursor: pointer;\n  width: 100%;\n  max-height: 100%;\n  max-width: 100%;\n  min-height: calc(${style_1.CssVar.size} * 3);\n  user-select: none;\n}\n.${exports.fileListViewClassName}-input {\n  height: 0px !important;\n  width: 0px !important;\n  opacity: 0px;\n  visibility: hidden;\n}\n.${exports.fileListViewClassName}-wrap {\n  ${style_1.CssPV.flex_c}\n  ${style_1.CssPV.f_y}\n  overflow: hidden;\n}\n.${exports.fileListViewClassName}-items {\n  ${style_1.CssPV.flex_c}\n  ${style_1.CssPV.f_y}\n}\n.${exports.fileListViewClassName}-items[data-opened="false"][data-count] {\n  overflow: hidden;\n}\n.${exports.fileListViewClassName}-accordion {\n  width: 100% !important;\n}\n.${exports.fileListViewClassName}-footer {\n  ${style_1.CssPV.flex_r_r}\n  flex: none;\n  width: 100%;\n}\n.${exports.fileListViewClassName}-sum-caption,\n.${exports.fileListViewClassName}-sum {\n  ${style_1.CssPV.flex_r}\n  flex: none;\n  padding: 2px 5px 0px 5px;\n}\n.${fileListViewItemClassName} {\n  ${style_1.CssPV.flex_r}\n  flex: none;\n  width: 100%;\n  height: ${style_1.CssVar.file_lv.itemHeight};\n  overflow: hidden;\n}\n.${fileListViewItemClassName}[data-delete="true"] {\n  opacity: 0.6;\n}\n.${fileListViewItemClassName}-download-wrap {\n  box-sizing: border-box;\n  min-width: ${style_1.CssVar.size};\n}\n.${fileListViewItemClassName}-name {\n  ${style_1.CssPV.flex_c}\n  min-width: 0px;\n  flex: 1;\n  overflow: hidden;\n}\n.${fileListViewItemClassName}-lbl {\n  box-sizing: border-box;\n  position: relative;\n  flex: none;\n  padding: 2px 5px 0px 5px;\n}\n.${fileListViewItemClassName}-file_name,\n.${fileListViewItemClassName}-file_path {\n  max-width: 100%;\n  overflow: hidden;\n  display: block;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n}\n.${fileListViewItemClassName}-file_path {\n  font-size: 10px;\n}\n${"material"===e?`\n.${exports.fileListViewClassName}-dragdrop {\n  border: 1px dashed ${style_1.CssVar.bdc};\n  border-radius: ${style_1.CssParam.m.r};\n}\n.${exports.fileListViewClassName}-dragdrop:hover {\n  background: ${style_1.CssVar.bg.c_a};\n}\n.${exports.fileListViewClassName}-items {\n  border-radius: ${style_1.CssParam.m.r};\n}\n.${fileListViewItemClassName} {\n  padding: 5px;\n}\n`:""};\n${"neumorphism"===e?`\n.${exports.fileListViewClassName} {\n  padding: ${style_1.CssParam.n.ccvSdPdd};\n}\n.${exports.fileListViewClassName}-dragdrop {\n  box-shadow: ${style_1.CssParam.n.ccvSd};\n  background: ${style_1.CssParam.n.ccvBg};\n  border-top-left-radius: ${style_1.CssParam.n.r};\n  border-top-right-radius: ${style_1.CssParam.n.r};\n}\n.${exports.fileListViewClassName}-dragdrop:hover {\n  background: ${style_1.CssParam.n.accent.ccvBg};\n}\n.${exports.fileListViewClassName}-wrap {\n  padding: ${style_1.CssParam.n.sdPdd};\n  box-shadow: ${style_1.CssParam.n.ccvSd};\n  background: ${style_1.CssParam.n.ccvBg};\n}\n.${exports.fileListViewClassName}-items[data-opened="false"] {\n  overflow: visible;\n  margin-bottom: ${style_1.CssParam.n.sdPdd};\n}\n.${exports.fileListViewClassName}-wrap[data-acc="false"] {\n  border-bottom-left-radius: ${style_1.CssParam.n.r};\n  border-bottom-right-radius: ${style_1.CssParam.n.r};\n}\n.${fileListViewItemClassName} {\n  padding: ${style_1.CssParam.n.r};\n  box-shadow: ${style_1.CssParam.n.border.cvxSd};\n  border-radius: ${style_1.CssParam.n.r};\n}\n.${fileListViewItemClassName}:not(:last-child) {\n  margin-bottom: ${style_1.CssParam.n.sdPdd};\n}\n.${fileListViewItemClassName} .${input_1.InputClassNames.btn_o} {\n  margin-left: ${style_1.CssParam.n.sdPdd};\n  margin-right: ${style_1.CssParam.n.sdPdd};\n}\n.${exports.fileListViewClassName}-accordion.${input_1.InputClassNames.btn_o} {\n  border-top-left-radius: 0px;\n  border-top-right-radius: 0px;\n}\n`:""}\n`});