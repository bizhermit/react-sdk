"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,s,t,a){void 0===a&&(a=t),Object.defineProperty(e,a,{enumerable:!0,get:function(){return s[t]}})}:function(e,s,t,a){void 0===a&&(a=t),e[a]=s[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,s){Object.defineProperty(e,"default",{enumerable:!0,value:s})}:function(e,s){e.default=s}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var s={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(s,e,t);return __setModuleDefault(s,e),s},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PopupMessageStyle=exports.MessageHistory=exports.PopupMessage=exports.messageHistoryClassName=exports.popupMessageClassName=void 0;const string_utils_1=__importDefault(require("@bizhermit/basic-utils/dist/string-utils")),react_1=__importStar(require("react")),react_dom_1=__importDefault(require("react-dom")),icon_1=__importStar(require("../graphics/icon")),style_1=__importStar(require("../layouts/style")),classname_utils_1=require("../utils/classname-utils"),message_utils_1=require("../utils/message-utils"),popup_1=require("./popup");exports.popupMessageClassName="bh-ppu_msg",exports.messageHistoryClassName="bh-msg_his";const PopupMessage=()=>{const e=(0,react_1.useRef)(),s=(0,react_1.useRef)(0),t=(0,react_1.useContext)(message_utils_1.MessagesContext),[a,r]=(0,react_1.useState)([]),n=(0,react_1.useCallback)((()=>{e.current.style.display="none"}),[]);return(0,react_1.useEffect)((()=>{if(a.length>0){e.current?.style.removeProperty("display");let t=100;e.current?.style.removeProperty("width");const a=e.current?.getBoundingClientRect().width||0,r=++s.current,n=()=>{r===s.current&&(t-=1,t<0||(e.current&&(e.current.style.width=Math.floor(a*(t/100))+"px"),setTimeout((()=>n()),5)))};setTimeout((()=>n()),5e3)}}),[a]),(0,react_1.useEffect)((()=>{t.popup=e=>r(e??[])}),[]),react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement("div",{ref:e,className:`${exports.popupMessageClassName}`,onClick:n},(()=>{const e=[];for(let s=a.length-1;s>=0;s--){const t=a[s],r=[];let n="";switch(t.type){case"err":n="bh-err";break;case"warn":n="bh-warn";break;default:n="bh-info"}let l=0;if(string_utils_1.default.isEmpty(t.title))for(const e of t.messages)r.push(react_1.default.createElement("div",{key:l++,className:`${exports.popupMessageClassName}-item`},e.message));else r.push(react_1.default.createElement("div",{key:l++,className:`${exports.popupMessageClassName}-item`},t.title));e.push(react_1.default.createElement("div",{key:s,className:(0,classname_utils_1.className)(`${exports.popupMessageClassName}-group`,n)},react_1.default.createElement("div",{className:`${exports.popupMessageClassName}-item-icon`},react_1.default.createElement(icon_1.default,{image:t.type??"info"})),react_1.default.createElement("div",{className:`${exports.popupMessageClassName}-body`},r)))}return e})()),exports.PopupMessageStyle,popup_1.PopupStyle)};exports.PopupMessage=PopupMessage;const MessageHistory=()=>{const e=(0,react_1.useContext)(message_utils_1.MessagesContext),[s,t]=(0,react_1.useState)(0),[a,r]=(0,react_1.useState)(!1),n=(0,react_1.useRef)([]),l=(0,react_1.useCallback)((()=>({total:n.current.length,info:n.current.filter((e=>"info"===e.type)).length,warn:n.current.filter((e=>"warn"===e.type)).length,err:n.current.filter((e=>"err"===e.type)).length,verified:n.current.filter((e=>!0!==e.verified)).length})),[]),o=(0,react_1.useCallback)((()=>{const s=l();e.callbacks.forEach((e=>e(s)))}),[]),m=(0,react_1.useCallback)((()=>{n.current.splice(0,n.current.length),t((e=>e+1)),o()}),[]),i=(0,react_1.useCallback)((e=>{for(let s=0,t=n.current.length;s<t;s++){if(n.current[s]===e){n.current.splice(s,1);break}}t((e=>e+1)),o()}),[]),c=(0,react_1.useCallback)((()=>{r(!1)}),[]),{hnodes:d,bnodes:p}=(0,react_1.useMemo)((()=>{const s=[];if(!a)return{hnodes:react_1.default.createElement(react_1.default.Fragment,null),bnodes:s};let t=0,r=0,l=0;for(let a=n.current.length-1;a>=0;a--){const o=n.current[a],m=[];let c="";switch(o.type){case"err":l++,c="bh-err";break;case"warn":r++,c="bh-warn";break;default:t++,c="bh-info"}let d=0;for(const e of o.messages)m.push(react_1.default.createElement("div",{key:d++,className:`${exports.messageHistoryClassName}-item-message`},e.message));s.push(react_1.default.createElement("div",{key:a,className:(0,classname_utils_1.className)(`${exports.messageHistoryClassName}-item`,c,!0===o.verified?"bh-verified":"")},react_1.default.createElement("div",{className:`${exports.messageHistoryClassName}-item-header`},react_1.default.createElement("div",{className:`${exports.messageHistoryClassName}-item-icon`},react_1.default.createElement(icon_1.default,{image:o.type??"info"})),react_1.default.createElement("div",{className:`${exports.messageHistoryClassName}-item-title`},o.title),react_1.default.createElement("div",{className:`${exports.messageHistoryClassName}-item-timestamp`},e.getTimeText(o.timestamp)),react_1.default.createElement("div",{className:`${exports.messageHistoryClassName}-item-button`,onClick:()=>{i(o)}},react_1.default.createElement(icon_1.default,{image:"delete"}))),react_1.default.createElement("div",{className:`${exports.messageHistoryClassName}-item-body`},m)))}return{hnodes:react_1.default.createElement(react_1.default.Fragment,null,0===t?react_1.default.createElement(react_1.default.Fragment,null):react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement("div",{className:`${exports.messageHistoryClassName}-header-icon`},react_1.default.createElement(icon_1.default,{image:"info"})),react_1.default.createElement("div",{className:`${exports.messageHistoryClassName}-header-count`},t)),0===r?react_1.default.createElement(react_1.default.Fragment,null):react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement("div",{className:`${exports.messageHistoryClassName}-header-icon`},react_1.default.createElement(icon_1.default,{image:"warn"})),react_1.default.createElement("div",{className:`${exports.messageHistoryClassName}-header-count`},r)),0===l?react_1.default.createElement(react_1.default.Fragment,null):react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement("div",{className:`${exports.messageHistoryClassName}-header-icon`},react_1.default.createElement(icon_1.default,{image:"err"})),react_1.default.createElement("div",{className:`${exports.messageHistoryClassName}-header-count`},l))),bnodes:s}}),[s,a]);return(0,react_1.useEffect)((()=>{a&&(n.current.forEach((e=>e.verified=!0)),o())}),[s,a]),(0,react_1.useEffect)((()=>{if(a)return window.addEventListener("click",c),()=>{window.removeEventListener("click",c)}}),[a]),(0,react_1.useEffect)((()=>{e.showHistory=()=>r(!0),e.closeHistory=()=>c(),e.append=e=>{for(const s of e)n.current.push(s);t((e=>e+1)),o()},e.clear=()=>m(),e.getCounts=()=>l()}),[]),a?react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement("div",{className:`${exports.messageHistoryClassName}`,onClick:e=>e.stopPropagation()},react_1.default.createElement("div",{className:`${exports.messageHistoryClassName}-header`},react_1.default.createElement("div",{className:`${exports.messageHistoryClassName}-header-button`,onClick:()=>t((e=>e+1))},react_1.default.createElement(icon_1.default,{image:"reload"})),react_1.default.createElement("div",{className:`${exports.messageHistoryClassName}-header-content`},d),react_1.default.createElement("div",{className:`${exports.messageHistoryClassName}-header-button`,onClick:m},react_1.default.createElement(icon_1.default,{image:"delete"})),react_1.default.createElement("div",{className:`${exports.messageHistoryClassName}-header-button`,onClick:c},react_1.default.createElement(icon_1.default,{image:"close"}))),react_1.default.createElement("div",{className:`${style_1.scrollbarClassName} ${exports.messageHistoryClassName}-body`},p)),MessageHistoryStyle):react_1.default.createElement(react_1.default.Fragment,null)};exports.MessageHistory=MessageHistory,exports.PopupMessageStyle=react_1.default.createElement(style_1.default,{id:exports.popupMessageClassName,notDepsColor:!0,css:({design:e})=>`\n.${exports.popupMessageClassName} {\n  z-index: 2100000001;\n  box-sizing: border-box;\n  position: fixed;\n  display: flex;\n  flex-flow: column nowrap;\n  justify-content: flex-start;\n  align-items: flex-start;\n  flex: none;\n  top: 0px;\n  right: 0px;\n  max-height: 100%;\n  max-width: 50%;\n  background: transparent;\n  overflow: hidden;\n  user-select: none;\n}\n.${exports.popupMessageClassName}-group {\n  ${style_1.CssPV.flex_r_c}\n  flex: none;\n  max-width: 100%;\n  background: ${style_1.CssVar.bg.c};\n}\n.${exports.popupMessageClassName}-body {\n  ${style_1.CssPV.flex_c}\n  ${style_1.CssPV.f_x}\n}\n.${exports.popupMessageClassName}-item {\n  ${style_1.CssPV.flex_r}\n  flex: none;\n  white-space: nowrap;\n  overflow: hidden;\n  padding: 1px 10px 0px 10px;\n  height: ${style_1.CssVar.size};\n}\n${"material"===e?`\n.${exports.popupMessageClassName} {\n  filter: drop-shadow(0px 8px 5px ${style_1.CssVar.shadow.dc});\n  top: 5px;\n  right: 5px;\n}\n.${exports.popupMessageClassName}-group {\n  border: 3px double ${style_1.CssVar.bdc};\n  border-radius: ${style_1.CssParam.m.r};\n  min-width: 150px;\n}\n.${exports.popupMessageClassName}-group.bh-warn {\n  background: ${style_1.CssVar.warn.bg.c};\n  border-color: ${style_1.CssVar.warn.bdc};\n}\n.${exports.popupMessageClassName}-group.bh-err {\n  background: ${style_1.CssVar.err.bg.c};\n  border-color: ${style_1.CssVar.err.bdc};\n}\n`:""}\n${"neumorphism"===e?`\n.${exports.popupMessageClassName} {\n  filter: drop-shadow(0px 8px 5px ${style_1.CssVar.shadow.dc});\n  top: 5px;\n  right: 5px;\n}\n.${exports.popupMessageClassName}-group {\n  border-radius: ${style_1.CssParam.n.r};\n  min-width: 150px;\n  box-shadow: ${style_1.CssParam.n.border.cvxSd};\n  background: ${style_1.CssParam.n.cvxBg};\n  padding: ${style_1.CssParam.n.r};\n}\n.${exports.popupMessageClassName}-group.bh-warn {\n  background: ${style_1.CssParam.n.warn.cvxBg};\n}\n.${exports.popupMessageClassName}-group.bh-err {\n  background: ${style_1.CssParam.n.err.cvxBg};\n}\n`:""}\n`});const MessageHistoryStyle=react_1.default.createElement(style_1.default,{id:exports.messageHistoryClassName,notDepsColor:!0,css:({design:e})=>`\n.${exports.messageHistoryClassName} {\n  z-index: 2100000000;\n  box-sizing: border-box;\n  position: fixed;\n  display: flex;\n  flex-flow: column nowrap;\n  justify-content: flex-start;\n  align-items: flex-start;\n  flex: none;\n  top: 0px;\n  right: 0px;\n  height: 100%;\n  min-width: 400px;\n  max-width: 50%;\n  background: ${style_1.CssVar.bg.c};\n  overflow: hidden;\n}\n.${exports.messageHistoryClassName}-header {\n  ${style_1.CssPV.flex_r}\n  flex: none;\n  height: ${style_1.CssVar.size};\n  width: 100%;\n  overflow: hidden;\n}\n.${exports.messageHistoryClassName}-header-content {\n  ${style_1.CssPV.flex_r}\n  ${style_1.CssPV.f_x}\n}\n.${exports.messageHistoryClassName}-header-button,\n.${exports.messageHistoryClassName}-header-icon,\n.${exports.messageHistoryClassName}-item-button {\n  box-sizing: border-box;\n  position: relative;\n  height: ${style_1.CssVar.size};\n  width: ${style_1.CssVar.size};\n  flex: none;\n}\n.${exports.messageHistoryClassName}-header-button,\n.${exports.messageHistoryClassName}-item-button {\n  cursor: pointer;\n}\n.${exports.messageHistoryClassName}-header-button > .${icon_1.iconClassName},\n.${exports.messageHistoryClassName}-item-button > .${icon_1.iconClassName} {\n  height: 100%;\n  width: 100%;\n}\n.${exports.messageHistoryClassName}-header-icon {\n  margin-left: 10px\n}\n.${exports.messageHistoryClassName}-header-count {\n  padding: 2px 0px 0px 3px;\n}\n.${exports.messageHistoryClassName}-body {\n  ${style_1.CssPV.flex}\n  flex-flow: column nowrap;\n  justify-content: flex-start;\n  align-items: stretch;\n  ${style_1.CssPV.f_y}\n}\n.${exports.messageHistoryClassName}-item {\n  ${style_1.CssPV.flex}\n  flex-flow: column nowrap;\n  justify-content: flex-start;\n  align-items: stretch;\n  flex: none;\n  max-width: 100%;\n}\n.${exports.messageHistoryClassName}-item-header {\n  ${style_1.CssPV.flex_r}\n  flex: none;\n  width: 100%;\n}\n.${exports.messageHistoryClassName}-item-title {\n  ${style_1.CssPV.flex_r}\n  ${style_1.CssPV.f_x}\n  padding: 1px 0px 0px 5px;\n}\n.${exports.messageHistoryClassName}-item-timestamp {\n  box-sizing: border-box;\n  font-size: 10px;\n  padding: 2px 3px 0px 3px;\n}\n.${exports.messageHistoryClassName}-item-body {\n  ${style_1.CssPV.flex_c}\n  padding-left: calc(${style_1.CssVar.size} / 2);\n}\n.${exports.messageHistoryClassName}-item-message {\n  box-sizing: border-box;\n  white-space: wrap;\n  max-width: 100%;\n}\n${"material"===e?`\n.${exports.messageHistoryClassName} {\n  border-left: 1px solid ${style_1.CssVar.bdc};\n  box-shadow: ${style_1.CssParam.m.sdLeft};\n}\n.${exports.messageHistoryClassName}-header {\n  border-bottom: 1px solid ${style_1.CssVar.bdc};\n  box-shadow: ${style_1.CssParam.m.sdBtm};\n  height: calc(${style_1.CssVar.size} + ${style_1.CssParam.m.sdPdd} * 2);\n  padding: ${style_1.CssParam.m.sdPdd};\n  margin-bottom: ${style_1.CssParam.m.sdPdd};\n  background: ${style_1.CssVar.bg.c_h};\n}\n.${exports.messageHistoryClassName}-header-button,\n.${exports.messageHistoryClassName}-item-button {\n  border-radius: ${style_1.CssParam.m.r};\n  border: 1px solid transparent;\n}\n.${exports.messageHistoryClassName}-header-button + .${exports.messageHistoryClassName}-header-button {\n  margin-left: 5px;\n}\n.${exports.messageHistoryClassName}-header-button:hover,\n.${exports.messageHistoryClassName}-item-button:hover {\n  margin-top: calc(${style_1.CssParam.m.updownMargin} * -0.5);\n  margin-bottom: calc(${style_1.CssParam.m.updownMargin} * 0.5);\n  box-shadow: ${style_1.CssParam.m.sdBtm_f};\n  border-color: ${style_1.CssVar.bdc};\n}\n.${exports.messageHistoryClassName}-header-button:hover:active,\n.${exports.messageHistoryClassName}-item-button:hover:active {\n  margin-top: calc(${style_1.CssParam.m.updownMargin} * 0.5);\n  margin-bottom: calc(${style_1.CssParam.m.updownMargin} * -0.5);\n  box-shadow: none;\n}\n.${exports.messageHistoryClassName}-body {\n  padding: 5px;\n}\n.${exports.messageHistoryClassName}-item {\n  border: 1px solid ${style_1.CssVar.bdc};\n  border-radius: ${style_1.CssParam.m.r};\n  padding: 5px;\n}\n.${exports.messageHistoryClassName}-item + .${exports.messageHistoryClassName}-item {\n  margin-top: 5px;\n}\n.${exports.messageHistoryClassName}-item.bh-verified {\n  border-style: dashed;\n}\n.${exports.messageHistoryClassName}-item.bh-warn {\n  border-color: ${style_1.CssVar.warn.bdc};\n  background: ${style_1.CssVar.warn.bg.c};\n}\n.${exports.messageHistoryClassName}-item.bh-err {\n  border-color: ${style_1.CssVar.err.bdc};\n  background: ${style_1.CssVar.err.bg.c};\n}\n`:""}\n${"neumorphism"===e?`\n.${exports.messageHistoryClassName} {\n  box-shadow: ${style_1.CssParam.n.accent.cvxSd};\n  background: ${style_1.CssParam.n.cvxBg};\n  padding: ${style_1.CssParam.n.accent.sdPdd};\n}\n.${exports.messageHistoryClassName}-header {\n  box-shadow: ${style_1.CssParam.n.accent.cvxSd};\n  background: ${style_1.CssParam.n.headerCvxBg};\n  border-radius: ${style_1.CssParam.n.r};\n  height: calc(${style_1.CssVar.size} + ${style_1.CssParam.n.sdPdd} * 2);\n  padding: ${style_1.CssParam.n.sdPdd};\n  margin-bottom: ${style_1.CssParam.n.accent.sdPdd};\n}\n.${exports.messageHistoryClassName}-header-button,\n.${exports.messageHistoryClassName}-item-button {\n  border-radius: ${style_1.CssParam.n.r};\n}\n.${exports.messageHistoryClassName}-header-button + .${exports.messageHistoryClassName}-header-button {\n  margin-left: ${style_1.CssParam.n.sdPdd};\n}\n.${exports.messageHistoryClassName}-header-button:hover,\n.${exports.messageHistoryClassName}-item-button:hover {\n  box-shadow: ${style_1.CssParam.n.cvxSd_f};\n  background: ${style_1.CssParam.n.cvxBg};\n}\n.${exports.messageHistoryClassName}-header-button:hover:active,\n.${exports.messageHistoryClassName}-item-button:hover:active {\n  box-shadow: ${style_1.CssParam.n.ccvSd};\n  background: ${style_1.CssParam.n.ccvBg};\n  padding-top: 1px;\n} \n.${exports.messageHistoryClassName}-item {\n  box-shadow: ${style_1.CssParam.n.cvxSd};\n  background: ${style_1.CssParam.n.cvxBg};\n  border-radius: ${style_1.CssParam.n.r};\n  padding: ${style_1.CssParam.n.sdPdd};\n  margin: ${style_1.CssParam.n.sdPdd};\n}\n.${exports.messageHistoryClassName}-item.bh-verified {\n  box-shadow: ${style_1.CssParam.n.border.ccvSd};\n  background: ${style_1.CssParam.n.ccvBg};\n}\n.${exports.messageHistoryClassName}-item-header .${exports.messageHistoryClassName}-item-button {\n  margin-left: ${style_1.CssParam.n.sdPdd};\n}\n.${exports.messageHistoryClassName}-item.bh-warn {\n  background: ${style_1.CssParam.n.warn.cvxBg};\n}\n.${exports.messageHistoryClassName}-item.bh-warn.bh-verified {\n  background: ${style_1.CssParam.n.warn.ccvBg};\n}\n.${exports.messageHistoryClassName}-item.bh-err {\n  background: ${style_1.CssParam.n.err.cvxBg};\n}\n.${exports.messageHistoryClassName}-item.bh-err.bh-verified {\n  background: ${style_1.CssParam.n.err.ccvBg};\n}\n`:""}\n`}),useMessage=e=>{const s=(0,react_1.useContext)(message_utils_1.MessagesContext),t=(0,style_1.useLayout)(),a=(0,react_1.useCallback)((e=>{if(null==e||0===e.length)return;const t=[];let a="",r="";for(const s of e){s.type===a&&s.title===r||(a=s.type,r=s.title,t.push({type:s.type,title:s.title,messages:[],timestamp:Date.now()}));const e=t[t.length-1];e.messages.push({type:s.type,title:e.title,message:s.message,timestamp:e.timestamp})}s.append(t),s.popup(t)}),[]),r=(0,react_1.useCallback)((e=>{console.log(e),a([{title:"システムエラー",message:"システムエラーが発生しました",type:"err"}])}),[]),n=(0,react_1.useCallback)((()=>{s.clear()}),[]),l=(0,react_1.useCallback)((()=>{s.showHistory()}),[]),o=(0,react_1.useCallback)((()=>{s.closeHistory()}),[]);return(0,react_1.useEffect)((()=>{let e;e=document.getElementById("bhMessageHistory"),null==e&&(e=document.createElement("div"),e.id="bhMessageHistory",document.body.appendChild(e)),react_dom_1.default.render(react_1.default.createElement(style_1.StyleContext.Provider,{value:t},react_1.default.createElement(exports.MessageHistory,null)),e),e=document.getElementById("bhPopupMessage"),null==e&&(e=document.createElement("div"),e.id="bhPopupMessage",document.body.appendChild(e)),react_dom_1.default.render(react_1.default.createElement(style_1.StyleContext.Provider,{value:t},react_1.default.createElement(exports.PopupMessage,null)),e)}),[t]),(0,react_1.useEffect)((()=>{if(e)return s.callbacks.push(e),e(s.getCounts()),()=>{for(let t=0,a=s.callbacks.length;t<a;t++)if(s.callbacks[t]===e){s.callbacks.splice(t,1);break}}}),[e]),{append:a,error:r,clear:n,showHistory:l,closeHistory:o}};exports.default=useMessage;